---
phase: 01-pdf-generation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "vps-proposal-fixed__5__1 (1) (1).html"
autonomous: true
requirements:
  - PDF-01
  - PDF-02
  - PDF-03
  - PDF-04
  - PDF-05
  - PDF-06
  - PDF-07
  - PDF-08
  - IMPL-01
  - IMPL-02
  - IMPL-03
  - IMPL-04

must_haves:
  truths:
    - "After signing and clicking Submit, the downloaded PDF contains all 10 proposal sections — not just the one visible on screen"
    - "The PDF renders with the dark background (#080808) and IBM Plex Mono / Bebas Neue typography matching the proposal webpage"
    - "The drawn signature appears in the PDF at the correct location with client name and signed date visible beneath it"
    - "The PDF filename is VPS-Proposal-Signed-[ClientName].pdf and downloads automatically"
    - "The Submit button shows a generating state while the PDF builds and re-enables when done; no fetch to localhost or any server occurs"
    - "Client validation (name required, signature required) still runs before PDF generation begins"
  artifacts:
    - path: "vps-proposal-fixed__5__1 (1) (1).html"
      provides: "Inline html2pdf.bundle.min.js replacing jsPDF and html2canvas inline blocks"
      contains: "html2pdf"
    - path: "vps-proposal-fixed__5__1 (1) (1).html"
      provides: "Rewritten generatePDF() using html2pdf capture approach"
      contains: "html2pdf().set(opt).from(document.body).save()"
  key_links:
    - from: "submitBtn click handler"
      to: "generatePDF()"
      via: "existing async event delegation at line ~2691"
      pattern: "await generatePDF"
    - from: "generatePDF()"
      to: "html2pdf pipeline"
      via: "html2pdf().set(opt).from(document.body).save()"
      pattern: "html2pdf\\(\\)"
    - from: "onclone callback"
      to: "all .section elements"
      via: "querySelectorAll('.section').forEach — display: block"
      pattern: "querySelectorAll.*\\.section"
    - from: "onclone callback"
      to: "sigCanvas element"
      via: "replace canvas with img using sigDataURL"
      pattern: "sigDataURL"
---

<objective>
Replace the custom 11-page hand-rolled PDF layout with an html2pdf.js DOM-capture approach that faithfully outputs the full proposal — dark background, all sections, embedded signature, client name, and signed date — running entirely in the browser.

Purpose: The current generatePDF() constructs 11 offscreen template pages from scratch using JavaScript-assembled HTML strings, which produces a PDF that misses section content and looks nothing like the actual webpage. The replacement approach screenshots the live DOM directly, eliminating the root cause.

Output: A single modified HTML file where (1) the inline jsPDF and html2canvas library blobs are replaced with the html2pdf.bundle.min.js inline bundle, and (2) the entire generatePDF() body is replaced with a ~40-line html2pdf capture implementation.
</objective>

<execution_context>
@C:/Users/jorda/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jorda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-pdf-generation-fix/01-RESEARCH.md

<interfaces>
<!-- Key DOM structure and JavaScript contracts the executor needs. -->
<!-- No codebase exploration required — these are extracted from the file. -->

File: vps-proposal-fixed__5__1 (1) (1).html (2713 lines total)

Script block layout:
  Lines 1527–1536:  SignaturePad v5.1.3 inline script — KEEP AS-IS
  Lines 1537–1910:  jsPDF 4.2.0 inline script — REMOVE ENTIRELY
  Lines 1911–1932:  html2canvas 1.4.1 inline script — REMOVE ENTIRELY
  Lines 1934–2711:  Main app script (IIFE) — MODIFY generatePDF() inside this block

Key DOM element IDs:
  #clientName     — text input, full name field (required, validated before PDF)
  #clientEmail    — text input, email (read but not validated)
  #clientDate     — date input (formatted to "January 1, 2025" for display)
  #sigCanvas      — canvas element where SignaturePad draws (width: 100%, height: 140px)
  #sigPadWrap     — wrapper div around sigCanvas (gets border highlight on validation error)
  #sigStatus      — status message span shown during/after generation
  #submitBtn      — submit button (disabled + text changed during generation)

CSS section selectors:
  .section                    — base class, display: none by default
  .section.active             — display: block (current visible section)
  Section IDs: s01 through s10

JavaScript globals in main app script:
  var signaturePad = null;    — initialized as new SignaturePad(canvas, {...}) on DOMContentLoaded
  function showFieldError(fieldId, message) — shows inline error; call before returning on validation fail
  async function generatePDF() — the function to REPLACE (lines 2089–2669 approximately)

Submit button handler (KEEP — do not modify):
  Existing click delegation at line ~2691:
    btn.textContent = '⏳ Generating PDF...'; btn.disabled = true;
    await generatePDF();
    btn.textContent = '✓ Submit & Download PDF'; btn.disabled = false;

Current library globals (will be REMOVED with old script blocks):
  window.jspdf       — exposed by the jsPDF 4.2.0 inline blob
  window.html2canvas — exposed by the html2canvas 1.4.1 inline blob

New global after Task 1:
  window.html2pdf    — exposed by html2pdf.bundle.min.js (contains html2canvas + jsPDF internally)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inline html2pdf bundle, remove old library blobs</name>
  <files>vps-proposal-fixed__5__1 (1) (1).html</files>
  <action>
    Fetch the html2pdf.bundle.min.js bundle from CDN and inline it as a script block, replacing the two existing inline library blocks.

    Step 1 — Fetch the bundle:
    Run this command to download the bundle content:
      curl -s "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" -o /tmp/html2pdf.bundle.min.js

    Verify the download succeeded (file should be ~300KB, non-empty).

    Step 2 — Edit the HTML file:
    Remove these two complete script blocks from the file:
      a) The jsPDF block: starts at the line containing `<script>/** @license` followed by `jsPDF - PDF Document creation from JavaScript` (line ~1537), ends at the matching `</script>` (line ~1910).
      b) The html2canvas block: starts at the `<script>` tag containing `html2canvas 1.4.1` (line ~1911), ends at its matching `</script>` (line ~1932).

    In the exact location where those two blocks were (between the SignaturePad `</script>` at line ~1536 and the empty `<script>` at line ~1934 that begins the app), insert a new script block:

      <script>
      [PASTE FULL CONTENT OF /tmp/html2pdf.bundle.min.js HERE]
      </script>

    The result must be: SignaturePad script block → html2pdf bundle script block → main app script block.

    Do NOT touch the SignaturePad block (lines 1527–1536) or the main app IIFE block (line ~1934 onward).

    CRITICAL — library conflict: The old blocks exposed `window.jspdf` and `window.html2canvas`. The html2pdf bundle bundles both internally and exposes `window.html2pdf`. After this change, the library check in generatePDF() (checking `window.jspdf && window.html2canvas`) will always fail until Task 2 replaces it. This is expected and correct — do not modify it yet.
  </action>
  <verify>
    Open the HTML file and confirm:
    1. Search for "jsPDF - PDF Document creation from JavaScript" — must NOT appear anywhere in the file
    2. Search for "html2canvas 1.4.1" — must NOT appear anywhere in the file
    3. Search for "html2pdf" — must appear (from the inlined bundle)
    4. The file must still open in a browser without a syntax error (SignaturePad script and main app script still intact)
    5. File size check: `wc -c "vps-proposal-fixed__5__1 (1) (1).html"` — file should still be large (the bundle is ~300KB, similar to what was removed)
  </verify>
  <done>
    The HTML file contains exactly one inline library block between SignaturePad and the main app script. That block is the html2pdf.bundle.min.js content. The old jsPDF and html2canvas blobs are gone. window.html2pdf will be defined when the page loads.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace generatePDF() with html2pdf capture implementation</name>
  <files>vps-proposal-fixed__5__1 (1) (1).html</files>
  <action>
    Locate the existing `async function generatePDF()` in the main app script block (around line 2089 after Task 1 edits). Replace the ENTIRE function body — from the opening `{` after `async function generatePDF()` through the matching closing `}` before the `// ── EVENT DELEGATION ──` comment — with the implementation below.

    Do NOT modify anything outside generatePDF(): leave the submit button event delegation handler, the recalcTotals() call, and the IIFE closing unchanged.

    REPLACEMENT generatePDF() BODY — paste this exactly between the existing `async function generatePDF() {` opening and the closing `}`:

    ```javascript
      var clientName  = (document.getElementById('clientName')  || {}).value || '';
      var clientEmail = (document.getElementById('clientEmail') || {}).value || '';
      var clientDate  = (document.getElementById('clientDate')  || {}).value || '';

      // Format date for display in PDF
      var dateObj    = clientDate ? new Date(clientDate + 'T12:00:00') : new Date();
      var months     = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      var formattedDate = months[dateObj.getMonth()] + ' ' + dateObj.getDate() + ', ' + dateObj.getFullYear();

      var st = document.getElementById('sigStatus');

      // Guard: library loaded
      if (typeof html2pdf === 'undefined') {
        if (st) { st.textContent = '⚠ PDF library not loaded. Please refresh the page.'; st.style.color = 'rgba(230,170,80,0.95)'; st.style.display = 'block'; }
        return;
      }

      // Guard: client name required
      if (!clientName.trim()) {
        showFieldError('clientName', 'Enter your full name above before submitting.');
        return;
      }

      // Guard: signature required
      if (!signaturePad || signaturePad.isEmpty()) {
        var wrap = document.getElementById('sigPadWrap');
        if (wrap) { wrap.style.borderColor = 'rgba(230,170,80,0.8)'; setTimeout(function(){ wrap.style.borderColor=''; }, 3000); wrap.scrollIntoView({behavior:'smooth', block:'center'}); }
        if (st) { st.textContent = '⚠ Please draw your signature before submitting.'; st.style.color = 'rgba(230,170,80,0.95)'; st.style.display = 'block'; }
        return;
      }

      if (st) { st.textContent = 'Generating PDF… please wait.'; st.style.color = 'rgba(200,198,194,0.7)'; st.style.display = 'block'; }

      // Capture signature data URL BEFORE cloning (live canvas is accessible; clone canvas may be tainted)
      var sigDataURL = signaturePad.toDataURL('image/png');
      var safeName   = clientName.replace(/[^a-zA-Z0-9\s\-]/g, '').replace(/\s+/g, '-').trim() || 'Client';

      // Wait for Google Fonts to finish loading (IBM Plex Mono, Bebas Neue)
      // Without this, html2canvas may capture system fallback fonts instead
      await document.fonts.ready;

      var opt = {
        margin:  0,
        filename: 'VPS-Proposal-Signed-' + safeName + '.pdf',
        image:   { type: 'jpeg', quality: 0.95 },
        html2canvas: {
          scale:           2,
          useCORS:         true,
          allowTaint:      true,
          backgroundColor: '#080808',
          logging:         false,
          windowWidth:     816,
          imageTimeout:    0,
          onclone: function(clonedDoc) {
            // Make ALL sections visible in the clone — does not affect live page navigation state
            clonedDoc.querySelectorAll('.section').forEach(function(s) {
              s.style.display = 'block';
            });

            // Replace signature canvas with <img> to avoid tainted-canvas blank rendering
            var sigEl = clonedDoc.getElementById('sigCanvas');
            if (sigEl && sigDataURL) {
              var img = clonedDoc.createElement('img');
              img.src = sigDataURL;
              img.style.display    = 'block';
              img.style.width      = '100%';
              img.style.height     = '140px';
              img.style.objectFit  = 'contain';
              sigEl.parentNode.replaceChild(img, sigEl);
            }

            // Bake input field values into visible <div> elements
            // (html2canvas renders input.value inconsistently across browsers — use text nodes instead)
            [
              { id: 'clientName', value: clientName },
              { id: 'clientDate', value: formattedDate }
            ].forEach(function(field) {
              var input = clonedDoc.getElementById(field.id);
              if (input) {
                var div = clonedDoc.createElement('div');
                div.className  = input.className;
                div.style.cssText = input.style.cssText || '';
                div.style.color   = '#F0EDE8';
                div.style.display = 'block';
                div.textContent   = field.value;
                input.parentNode.insertBefore(div, input.nextSibling);
                input.style.display = 'none';
              }
            });
          }
        },
        jsPDF: { unit: 'pt', format: 'letter', orientation: 'portrait', compress: true }
      };

      try {
        await html2pdf().set(opt).from(document.body).save();
        if (st) { st.textContent = '✓ PDF downloaded successfully.'; st.style.color = 'rgba(180,220,160,0.9)'; }
      } catch(err) {
        if (st) { st.textContent = '⚠ PDF error: ' + (err.message || err); st.style.color = 'rgba(230,170,80,0.9)'; st.style.display = 'block'; }
        console.error('generatePDF error:', err);
      }
    ```

    DECISIONS built into this implementation (per research):
    - image.type: 'jpeg' is safe here because backgroundColor is explicitly set to '#080808' (no transparent areas to show as white)
    - onclone is used for section-reveal and canvas-swap (not live DOM manipulation) — prevents navigation state corruption on error
    - document.fonts.ready ensures IBM Plex Mono and Bebas Neue are loaded before capture
    - formattedDate is pre-computed before onclone and captured in closure — date input is hidden, formatted string shown
    - The function body of the old generatePDF (the offscreen-wrap, makePage, 11-page loop, doc.addImage loop, and getSelectedServices call) is entirely removed

    Also add this CSS rule inside the existing `<style>` block in `<head>` (add before the closing `</style>` tag to force background color printing):
    ```css
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    ```
  </action>
  <verify>
    1. Open the HTML file in a browser (Chrome or Edge recommended)
    2. Navigate to section 10 (Next Steps) using the nav buttons
    3. Enter a client name (e.g. "Jane Smith") and select a date
    4. Draw a signature on the pad
    5. Click "Submit & Download PDF"
    6. Verify: button shows "⏳ Generating PDF..." while generating
    7. Verify: PDF downloads automatically (no save dialog choosing location required for auto-download)
    8. Open the downloaded PDF and verify ALL of:
       a. File named "VPS-Proposal-Signed-Jane-Smith.pdf"
       b. All 10 proposal sections are present (not just the active one)
       c. Dark background (#080808) throughout — no white pages
       d. IBM Plex Mono and Bebas Neue fonts render correctly (not system monospace fallback)
       e. Drawn signature appears at the correct location
       f. "Jane Smith" and the formatted date appear in the signature block
    9. Verify button re-enables after download completes
    10. Open browser DevTools Network tab, trigger generation — confirm zero fetch requests to localhost or any API

    Manual check for iOS (if available): Open on iPhone Safari, complete the flow, confirm PDF downloads without blank pages. If PDF is blank or truncated, reduce scale from 2 to 1.5 in the opt.html2canvas block as a fallback.
  </verify>
  <done>
    The generatePDF() function uses html2pdf().set(opt).from(document.body).save() exclusively. The old offscreen-wrap approach is gone. The downloaded PDF faithfully captures all 10 sections with dark styling, embedded signature, and client details. No server requests are made during generation.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, the HTML file should satisfy all 5 phase success criteria:

1. PDF contains all proposal sections — verified by opening PDF and counting sections
2. PDF has dark background and correct typography — visual check of PDF pages
3. Signature appears at correct location with name and date — visual check of signature block
4. Filename is VPS-Proposal-Signed-[ClientName].pdf — check downloaded file name
5. Submit button shows generating state; no server fetch — DevTools Network tab confirms

Quick functional smoke test (can be run as single browser session):
- Open file in browser
- Go to section 10
- Fill name + date + draw signature
- Click Submit
- Check: PDF downloads, filename correct, all sections present, dark background, signature visible
</verification>

<success_criteria>
- generatePDF() contains no reference to window.jspdf, window.html2canvas, makePage, pdf-render-wrap, or doc.addImage
- generatePDF() calls html2pdf().set(opt).from(document.body).save()
- Inline jsPDF blob (the "jsPDF - PDF Document creation from JavaScript" block) is absent from the file
- Inline html2canvas blob (the "html2canvas 1.4.1" block) is absent from the file
- html2pdf bundle content is present as an inline script block
- Downloaded PDF visually matches the proposal webpage (dark background, all sections, correct fonts)
- All 12 v1 requirements (PDF-01 through PDF-08, IMPL-01 through IMPL-04) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-pdf-generation-fix/01-01-SUMMARY.md` using the summary template.
</output>
